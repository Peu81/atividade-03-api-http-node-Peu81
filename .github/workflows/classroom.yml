Nome : Autoavaliação

ligado : [empurrar]

empregos :
  test-api :
    runs-on : ubuntu-latest

    passos :
      - usa : actions/checkout@v4

      - nome : Verificar commits mínimos
        executar : |
          COUNT=$(git rev-list --count HEAD)
          se [ "$COUNT" -lt 5 ]; então
            echo "Mínimo de 5 commits não atendidos: Atualmente $COUNT"
            saída 1
          fi
      - nome : Verificar se o arquivo do servidor existe
        executar : |
          teste -f src/server.js || (echo "src/server.js não encontrado" && exit 1)
      - nome : Check Express não utilizado
        executar : |
          se grep -Ri "express" .; então
            echo "Expresso não é permitido"
            saída 1
          fi
      - nome : Verificar uso do ESM
        executar : |
          se grep -R "require(" src; então
            echo "require() não permitido. Usar importação/exportação"
            saída 1
          fi
          grep -R "importar" src || (echo "importação não encontrada" && saída 1)
      - nome : Nó de Configuração
        utiliza : actions/setup-node@v4
        com :
          versão do nó : 20

      - nome : Instalar dependências
        executar : npm install

      - nome : Iniciar servidor
        executar : |
          node src/server.js &
          dormir 5
      - nome : Extrair matrícula
        id : matrícula
        executar : |
          MATRICULA=$(grep -i "Matrícula:" README.md | awk '{print $2}')
          ÚLTIMO_DÍGITO=${MATRICULA: -1}
          VARIACAO=$((ÚLTIMO_DÍGITO % 4))
          echo "variacao=$VARIACAO" >> $GITHUB_OUTPUT
      - nome : Definir recurso
        id : recurso
        executar : |
          se [ "${{ steps.matricula.outputs.variacao }}" = "0" ]; então
            echo "resource=atendimentos" >> $GITHUB_OUTPUT
          elif [ "${{ steps.matricula.outputs.variacao }}" = "1" ]; então
            echo "resource=chamados" >> $GITHUB_OUTPUT
          elif [ "${{ steps.matricula.outputs.variacao }}" = "2" ]; então
            echo "resource=protocolos" >> $GITHUB_OUTPUT
          outro
            echo "resource=requerimentos" >> $GITHUB_OUTPUT
          fi
      - nome : Instalar jq
        execute : sudo apt-get update && sudo apt-get install -y jq

      # -----------------------
      # TESTE SAÚDE
      # -----------------------

      - nome : Teste de estado de saúde 200
        executar : |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health)
          [ "$STATUS" = "200" ] || sair 1
      - nome : O teste de integridade retorna JSON
        executar : |
          curl -s http://localhost:3000/health | jq . > /dev/null
      # -----------------------
      # TESTE OBTER LISTA INICIAL
      # -----------------------

      - nome : Teste GET lista retorna array
        executar : |
          curl -s http://localhost:3000/${{ steps.resource.outputs.resource }} | jq 'type' | grep array
      # -----------------------
      # POSTAGEM DE TESTE VÁLIDO
      # -----------------------

      - nome : Criar primeiro item
        id : criar1
        executar : |
          RECURSO=${{ steps.resource.outputs.resource }}
          if [ "$RESOURCE" = "atendimentos" ]; então
            DATA='{"aluno":"João","assunto":"Duvida"}'
          elif [ "$RESOURCE" = "chamados" ]; então
            DATA='{"solicitante":"Maria","descricao":"Problema","prioridade":"alta"}'
          elif [ "$RESOURCE" = "protocolos" ]; então
            DATA='{"nome":"Carlos","tipo":"Interno","data":"2025-01-01"}'
          outro
            DATA='{"estudante":"Ana","categoria":"Financeiro","observacao":"Urgente"}'
          fi
          RESPOSTA=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/$RESOURCE \
            -H "Content-Type: application/json" \
            -d "$DADOS")
          CORPO=$(echo "$RESPOSTA" | head -n1)
          STATUS=$(echo "$RESPONSE" | tail -n1)
          [ "$STATUS" = "201" ] || sair 1
          ID=$(echo "$BODY" | jq '.id')
          echo "id1=$ID" >> $GITHUB_OUTPUT
      - nome : Criar segundo item (verificar ID incremental)
        executar : |
          RECURSO=${{ steps.resource.outputs.resource }}
          if [ "$RESOURCE" = "atendimentos" ]; então
            DATA='{"aluno":"Pedro","assunto":"Nota"}'
          elif [ "$RESOURCE" = "chamados" ]; então
            DATA='{"solicitante":"Luiz","descricao":"Erro","prioridade":"media"}'
          elif [ "$RESOURCE" = "protocolos" ]; então
            DATA='{"nome":"Julia","tipo":"Externo","data":"2025-02-01"}'
          outro
            DATA='{"estudante":"Bruno","categoria":"Académico","observacao":"Normal"}'
          fi
          RESPOSTA=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/$RESOURCE \
            -H "Content-Type: application/json" \
            -d "$DADOS")
          CORPO=$(echo "$RESPOSTA" | head -n1)
          STATUS=$(echo "$RESPONSE" | tail -n1)
          [ "$STATUS" = "201" ] || sair 1
          ID2=$(echo "$BODY" | jq '.id')
          ID1=${{ steps.create1.outputs.id1 }}
          [ "$ID2" -gt "$ID1" ] || sair 1
      # -----------------------
      # TESTE OBTER POR ID
      # -----------------------

      - nome : Teste GET por ID válido
        executar : |
          RECURSO=${{ steps.resource.outputs.resource }}
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/$RESOURCE/1)
          [ "$STATUS" = "200" ] || sair 1
      - nome : Teste GET com ID inválido retorna 404
        executar : |
          RECURSO=${{ steps.resource.outputs.resource }}
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/$RESOURCE/9999)
          [ "$STATUS" = "404" ] || sair 1
      # -----------------------
      # TESTES DE ERRO
      # -----------------------

      - nome : O teste JSON inválido retorna 400
        executar : |
          RECURSO=${{ steps.resource.outputs.resource }}
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:3000/$RESOURCE \
            -H "Content-Type: application/json" \
            -d '{ inválido')
          [ "$STATUS" = "400" ] || sair 1
      - nome : O teste de campo ausente retorna 422
        executar : |
          RECURSO=${{ steps.resource.outputs.resource }}
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:3000/$RESOURCE \
            -H "Content-Type: application/json" \
            -d '{}')
          [ "$STATUS" = "422" ] || sair 1
